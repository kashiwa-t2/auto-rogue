# CLAUDE.md

このファイルは Claude Code (claude.ai/code) がこのリポジトリでコードを扱う際のガイダンスを提供します。

## プロジェクト概要

auto-rogue プロジェクト - スマホ縦画面向けの放置ローグライクゲーム

### MVP 仕様 (最小実行可能プロダクト)

#### 画面構成

- **上部 1/3**: プレイエリア（プレイヤー・敵・背景スクロール）
- **下部 2/3**: UI エリア（拠点メニュー・強化・ボタン類）
- **解像度**: 720x1280 (スマホ縦画面)

#### ゲームループ

1. プレイヤーキャラが自動で前進
2. 敵と遭遇 → 自動戦闘
3. 敵を倒すとゴールドをドロップ
4. 冒険失敗（HP ゼロ）で拠点に戻る
5. 獲得したゴールドでキャラを強化
6. 再び冒険に出発

#### キャラクター仕様

- **プレイヤー**: 画面左下寄り固定位置で歩行アニメーション
- **敵**: 右端から出現し左方向に移動、プレイヤーに近づくと戦闘
- **戦闘**: 自動で交互攻撃（一定間隔）
- **ステータス**: HP、攻撃力、攻撃間隔

#### 技術要素

- **背景スクロール**: 右 → 左ループで移動感演出
- **シーン遷移**: 冒険シーン ⇔ 拠点シーン
- **セーブデータ**: JSON 形式でゴールド・強化値保存

## 開発状況

### 現在の実装状況

#### 完了した機能

- ✅ **基本ゲームシステム**: プレイヤー・敵・戦闘システムの実装
- ✅ **スクロールシステム**: 背景・地面の無限スクロール
- ✅ **戦闘システム**: プレイヤーと敵の双方向ダメージ・死ぬまで戦闘継続
- ✅ **HPシステム**: プレイヤー・敵の HP 管理と視覚的 HP バー表示
- ✅ **ダメージ表示システム**: フロート式ダメージ数値アニメーション
- ✅ **エネミーシステム**: 基底クラス継承による敵タイプ管理
- ✅ **UI 位置計算システム**: 動的スプライトサイズ対応の位置計算
- ✅ **コードリファクタリング**: UIPositionHelper による共通機能統合
- ✅ **コインシステム**: 敵撃破時の即座コイン取得・UI反映・視覚フィードバック（10-20コイン）
- ✅ **タイトル画面**: フェードインアニメーション・ゲーム開始ボタン
- ✅ **シーン遷移システム**: スムーズなフェードイン/アウト効果
- ✅ **ゲームオーバー画面**: 結果表示・タイトルへの復帰
- ✅ **育成システム**: コイン消費によるキャラクター・武器レベルアップ
- ✅ **ステータス管理**: PlayerStatsシングルトンによる永続的データ管理
- ✅ **複数敵同時出現システム**: 時間ベース無限敵出現・1対1戦闘・待機キュー制御

#### 実装中の機能

- 🚧 **ゲームプレイ拡張**: より多様な敵タイプと戦闘要素

#### アーキテクチャ改善

- **エネミー継承システム**: EnemyBase による拡張可能な敵システム
- **戦闘システム統合**: プレイヤー・敵・UI の連携制御
- **コード整理**: 関数の統一化と可読性向上

## 開発コマンド

- **実行**: Godot エディタで F6 キー
- **テスト**: 実行中に F12 キーでテスト実行
- **プロジェクトファイル**: project.godot

## プロジェクト構造

### コアファイル

- `src/scenes/`: シーンファイル (.tscn)
  - `TitleScene.tscn`: タイトル画面（ゲーム開始エントリポイント）
  - `MainScene.tscn`: メインゲーム画面（GameOverScreen含む）
  - `Player.tscn`: プレイヤーキャラクター（HP バー含む）
  - `BasicEnemy.tscn`: 基本敵キャラクター（HP バー含む）
  - `Coin.tscn`: コイン（回転アニメーション・価値表示）
- `src/scripts/`: スクリプトファイル (.gd)
  - `GameConstants.gd`: 定数管理 (autoload)
  - `SceneTransition.gd`: シーン遷移管理 (autoload)
  - `PlayerStats.gd`: プレイヤーステータス管理 (autoload)
  - `TitleScene.gd`: タイトル画面制御
  - `Player.gd`: プレイヤー制御 API（武器・攻撃・HP・コイン収集システム）
  - `MainScene.gd`: メインシーン・戦闘・ダメージ・ゴールドUI管理
  - `GameOverScreen.gd`: ゲームオーバー画面制御
  - `UpgradeUI.gd`: 育成画面UI制御
  - `TestPlayer.gd`: テスト機能

### エネミーシステム

- `EnemyBase.gd`: 敵キャラクターの基底クラス（HP・ダメージ・コイン生成システム含む）
- `BasicEnemy.gd`: 基本敵（突進攻撃タイプ）

### HPシステム

- `HPBar.gd`: HP バー表示用ユーティリティクラス
- 動的 HP 管理・色変化・シグナル通知機能

### ダメージ表示システム

- `DamageText.gd`: フロート式ダメージ数値表示クラス
- アニメーション付きダメージ表示

### UI位置計算システム

- `UIPositionHelper.gd`: UI要素位置計算ヘルパークラス
- 動的スプライトサイズ対応・共通位置計算ロジック

### コインシステム

- `Coin.gd`: コイン表示・価値表示・自動取得・消失システム
- 敵撃破時の即座取得・視覚フィードバック・UI反映

### シーン管理システム

- `SceneTransition.gd`: シーン遷移管理（シングルトン）
- `TitleScene.gd`: タイトル画面・ゲーム開始制御
- `GameOverScreen.gd`: ゲームオーバー画面・結果表示

### 育成・ステータス管理システム

- `PlayerStats.gd`: プレイヤーステータス管理（シングルトン）
- `UpgradeUI.gd`: 育成画面UI・レベルアップ制御

### スクロールシステム

- `ScrollerBase.gd`: スクロール要素の基底クラス
- `BackgroundScroller.gd`: 背景スクロール制御
- `GroundScroller.gd`: 地面スクロール制御
- `ScrollManager.gd`: 複数スクローラーの統一管理

### アセット

- `assets/sprites/kenney_pixel-platformer/`: ゲーム素材
  - `Tiles/Backgrounds/`: 背景画像 (tile_0008~0011)
  - `Tiles/Characters/`: キャラクター画像 (tile_0000~0001)
  - `Tiles/`: 地面タイル (tile_0022)、コイン画像 (tile_0151~0152)

## アーキテクチャ

### 階層化設計

1. **基底クラス**: ScrollerBase・EnemyBase で共通処理を統一
2. **具象クラス**: BackgroundScroller, GroundScroller, BasicEnemy で特化実装
3. **管理クラス**: ScrollManager で複数要素の制御、UIPositionHelper で UI 計算統一
4. **ユーティリティクラス**: HPBar・DamageText で再利用可能 UI コンポーネント
5. **定数管理**: GameConstants で論理的グループ分け

### プレイヤーシステム

- **スプライトアニメーション**: tile_0000/0001 の 2 フレーム歩行
- **武器システム**: 剣による攻撃アニメーション・ダメージ処理
- **HP システム**: HP バー表示・ダメージ受信・死亡処理
- **ダメージ表示**: 被ダメージ時のフロート数値表示
- **コイン収集システム**: 自動コイン取得・総数管理・UI反映
- **動的スケール**: GameConstants.PLAYER_SPRITE_SCALE (3.0 倍)
- **地面位置調整**: 自動計算による適切な接地
- **シグナル通知**: position_changed, player_reset, attack_started/finished, player_died, coin_collected

### エネミーシステム

- **継承アーキテクチャ**: EnemyBase 基底クラスによる拡張可能設計
- **戦闘状態管理**: 戦闘開始/終了の自動判定とアニメーション制御
- **攻撃パターン**: BasicEnemy の突進攻撃・ダメージ処理
- **HP システム**: 敵タイプ別 HP 設定・HP バー表示・死亡処理
- **ダメージ表示**: 被ダメージ時のフロート数値表示
- **コイン生成システム**: 死亡時の自動コイン生成・ランダム価値（10-20）
- **時間ベース出現**: 5秒間隔での自動敵出現・永続的無限ゲームプレイ
- **複数敵同時存在**: アクティブ敵配列による複数敵管理・画面上同時表示
- **タイプシステム**: EnemyType enum による敵種別管理

### 戦闘システム

- **1対1戦闘制御**: 複数敵存在下でも最初に接近した敵とのみ戦闘
- **戦闘ターゲット管理**: current_battle_target による明確な攻撃対象指定
- **待機キューシステム**: 2体目以降の敵は自動で待機状態・プレイヤー通り抜け防止
- **順次戦闘**: FIFO方式による待機敵との連続戦闘システム
- **双方向ダメージ**: プレイヤー ⇔ 戦闘ターゲット敵の相互攻撃システム
- **攻撃タイミング**: 突進完了時の正確なダメージ判定
- **視覚フィードバック**: ダメージ数値・HP バー・攻撃アニメーション
- **ゲーム進行制御**: 戦闘中の背景スクロール停止・敵移動は継続

### スクロールシステム

- **無限ループ**: 背景 4 枚・地面 1 枚の連続スクロール
- **統一制御**: ScrollManager による速度・状態管理
- **拡張性**: 新しいスクロール要素の簡単追加

### コインシステム

- **即座取得**: 敵撃破と同時に自動取得（衝突判定不要）
- **視覚フィードバック**: コインアイコン（tile_0151/0152）の回転アニメーション
- **価値表示**: コイン横に "+10"~"+20" 数字表示（フォントメトリクス対応）
- **ランダムドロップ**: 10-20コインのランダム生成
- **UI統合**: リアルタイムゴールド表示更新（左上コインアイコン + 数値）
- **自動管理**: 2秒後の自動消失・プレイヤー総コイン数追跡

### シーン遷移システム

- **SceneTransition autoload**: グローバルなシーン遷移管理
- **フェード効果**: 黒画面フェードイン/アウトでスムーズな遷移
- **タイトル画面**: 段階的なフェードイン演出・ボタンアニメーション
- **ゲームオーバー画面**: 結果表示・スケールアニメーション登場
- **シーン構成**: タイトル → メインゲーム → ゲームオーバー → タイトル（ループ）

### 育成システム

- **PlayerStats シングルトン**: レベル・コイン数の永続管理
- **キャラクター育成**: レベルアップでHP増加（+20/レベル）
- **武器育成**: レベルアップで攻撃力増加（+5/レベル）
- **コストシステム**: レベル比例コスト（レベル×基本コスト）
- **育成UI**: コイン数・レベルアップコスト・ステータス上昇量表示
- **アニメーション**: レベルアップ成功時のスケール・フラッシュ効果

### コード品質向上

- **継承設計**: 基底クラスによる機能の共通化
- **複数敵システム**: アクティブ敵配列・待機キュー・戦闘ターゲット管理
- **時間ベース設計**: Timer による敵出現・距離依存からの脱却
- **UI 位置計算統一**: UIPositionHelper による重複コード削減
- **動的位置計算**: スプライトサイズに基づく自動位置調整
- **ユーティリティクラス**: HPBar・DamageText の再利用可能設計
- **機能別セクション分け**: コードの可読性・保守性向上
- **一貫したログ**: 全クラスで統一されたログ出力形式
- **エラーハンドリング**: 安全なリソース読み込み処理

## テスト駆動開発

### 包括的テストスイート

- **プレイヤーテスト**: 移動・アニメーション・API
- **スクロールテスト**: ScrollManager・スクローラー状態
- **定数整合性テスト**: GameConstants の論理チェック
- **統合テスト**: システム全体の連携確認

### テスト実行

- **F12 キー**: 全自動テスト実行
- **手動テスト**: UI ボタンでの動作確認
- **デバッグログ**: 構造化された詳細ログ

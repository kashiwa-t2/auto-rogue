# CLAUDE.md

このファイルは Claude Code (claude.ai/code) がこのリポジトリでコードを扱う際のガイダンスを提供します。

## プロジェクト概要

auto-rogue プロジェクト - スマホ縦画面向けの放置ローグライクゲーム

### MVP 仕様 (最小実行可能プロダクト)

#### 画面構成

- **上部 1/3**: プレイエリア（プレイヤー・敵・背景スクロール）
- **下部 2/3**: UI エリア（拠点メニュー・強化・ボタン類）
- **解像度**: 720x1280 (スマホ縦画面)

#### ゲームループ

1. プレイヤーキャラが自動で前進
2. 敵と遭遇 → 自動戦闘
3. 敵を倒すとゴールドをドロップ
4. 冒険失敗（HP ゼロ）で拠点に戻る
5. 獲得したゴールドでキャラを強化
6. 再び冒険に出発

#### キャラクター仕様

- **プレイヤー**: 画面左下寄り固定位置で歩行アニメーション
- **敵**: 右端から出現し左方向に移動、プレイヤーに近づくと戦闘
- **戦闘**: 自動で交互攻撃（一定間隔）
- **ステータス**: HP、攻撃力、攻撃間隔

#### 技術要素

- **背景スクロール**: 右 → 左ループで移動感演出
- **シーン遷移**: 冒険シーン ⇔ 拠点シーン
- **セーブデータ**: JSON 形式でゴールド・強化値保存

## 開発状況

### 現在の実装状況

#### 完了した機能

- ✅ **基本ゲームシステム**: プレイヤー・敵・戦闘システムの実装
- ✅ **スクロールシステム**: 背景・地面の無限スクロール
- ✅ **戦闘システム**: プレイヤーと敵の双方向ダメージ・死ぬまで戦闘継続
- ✅ **HPシステム**: プレイヤー・敵の HP 管理と視覚的 HP バー表示
- ✅ **ダメージ表示システム**: フロート式ダメージ数値アニメーション
- ✅ **エネミーシステム**: 基底クラス継承による敵タイプ管理
- ✅ **UI 位置計算システム**: 動的スプライトサイズ対応の位置計算
- ✅ **コードリファクタリング**: UIPositionHelper による共通機能統合
- ✅ **コインシステム**: 敵撃破時の即座コイン取得・UI反映・視覚フィードバック（10-20コイン）
- ✅ **タイトル画面**: フェードインアニメーション・ゲーム開始ボタン
- ✅ **シーン遷移システム**: スムーズなフェードイン/アウト効果
- ✅ **ゲームオーバー画面**: 結果表示・タイトルへの復帰
- ✅ **育成システム**: コイン消費によるキャラクター・武器・攻撃速度・ポーション効果レベルアップ
- ✅ **ステータス管理**: PlayerStatsシングルトンによる永続的データ管理
- ✅ **複数敵同時出現システム**: 時間ベース無限敵出現
- ✅ **複数敵同時攻撃システム**: 複数の敵が独立して同時攻撃・個別タイマー管理
- ✅ **セーブシステム**: オートセーブ・即座セーブ・データ削除機能の完全実装
- ✅ **回復薬システム**: 20%確率でのポーションドロップ・即座HP回復・視覚的フィードバック
- ✅ **UI改善**: 育成パネルの共通化・2x2グリッド配置・中央揃え
- ✅ **敵移動システム改善**: 背景スクロールと連動した相対速度制御
- ✅ **個別接敵距離システム**: 敵タイプ別の接敵距離設定機能
- ✅ **魔法使い敵の実装**: 遠距離攻撃・魔法弾システム・新敵タイプ追加
- ✅ **セーブシステム拡張**: 攻撃速度・ポーション効果レベルの永続化対応

#### 実装中の機能

- 🚧 **ゲームプレイ拡張**: より多様な敵タイプと戦闘要素

#### アーキテクチャ改善

- **エネミー継承システム**: EnemyBase による拡張可能な敵システム
- **戦闘システム統合**: プレイヤー・敵・UI の連携制御
- **コード整理**: 関数の統一化と可読性向上

## 開発コマンド

- **実行**: Godot エディタで F6 キー
- **テスト**: 実行中に F12 キーでテスト実行
- **プロジェクトファイル**: project.godot

## プロジェクト構造

### コアファイル

- `src/scenes/`: シーンファイル (.tscn)
  - `TitleScene.tscn`: タイトル画面（ゲーム開始エントリポイント）
  - `MainScene.tscn`: メインゲーム画面（GameOverScreen含む）
  - `Player.tscn`: プレイヤーキャラクター（HP バー含む）
  - `BasicEnemy.tscn`: 基本敵キャラクター（HP バー含む）
  - `Coin.tscn`: コイン（回転アニメーション・価値表示）
  - `HealthPotion.tscn`: 回復薬（浮遊アニメーション・回復量表示）
  - `UpgradePanel.tscn`: 共通育成パネル（レベルアップUI）
- `src/scripts/`: スクリプトファイル (.gd)
  - `GameConstants.gd`: 定数管理 (autoload)
  - `SceneTransition.gd`: シーン遷移管理 (autoload)
  - `PlayerStats.gd`: プレイヤーステータス管理 (autoload)
  - `SaveManager.gd`: セーブ/ロード管理 (autoload)
  - `TitleScene.gd`: タイトル画面制御（オートセーブ検出・自動ボタンテキスト変更）
  - `Player.gd`: プレイヤー制御 API（武器・攻撃・HP・コイン収集システム）
  - `MainScene.gd`: メインシーン・戦闘・ダメージ・ゴールドUI管理・オートセーブ
  - `GameOverScreen.gd`: ゲームオーバー画面制御
  - `UpgradeUI.gd`: 育成画面UI制御
  - `TestPlayer.gd`: テスト機能

### エネミーシステム

- `EnemyBase.gd`: 敵キャラクターの基底クラス（HP・ダメージ・コイン生成・個別接敵距離システム含む）
- `BasicEnemy.gd`: 基本敵（突進攻撃タイプ）
- `MageEnemy.gd`: 魔法使い敵（遠距離攻撃タイプ）

### HPシステム

- `HPBar.gd`: HP バー表示用ユーティリティクラス
- 動的 HP 管理・色変化・シグナル通知機能

### ダメージ表示システム

- `DamageText.gd`: フロート式ダメージ数値表示クラス
- アニメーション付きダメージ表示

### UI位置計算システム

- `UIPositionHelper.gd`: UI要素位置計算ヘルパークラス
- 動的スプライトサイズ対応・共通位置計算ロジック

### コインシステム

- `Coin.gd`: コイン表示・価値表示・自動取得・消失システム
- 敵撃破時の即座取得・視覚フィードバック・UI反映

### 回復薬システム

- `HealthPotion.gd`: 回復薬表示・回復量表示・視覚的フィードバック
- 敵撃破時の20%確率ドロップ・即座HP回復・浮遊アニメーション

### 魔法弾システム

- `MagicBullet.gd`: 魔法使い敵の遠距離攻撃弾クラス
- プレイヤー追跡・距離判定・即座ダメージ処理

### シーン管理システム

- `SceneTransition.gd`: シーン遷移管理（シングルトン）
- `TitleScene.gd`: タイトル画面・ゲーム開始制御
- `GameOverScreen.gd`: ゲームオーバー画面・結果表示

### 育成・ステータス管理システム

- `PlayerStats.gd`: プレイヤーステータス管理（シングルトン）
- `UpgradeUI.gd`: 育成画面UI・レベルアップ制御（4種類レベルアップ対応）

### セーブシステム

- `SaveManager.gd`: オートセーブ管理（シングルトン）
- **自動保存機能**:
  - 30秒間隔でのバックグラウンド保存
  - ゲーム開始時の初回保存
  - コイン消費時の即座保存（レベルアップ等）
- **データ管理**:
  - コイン・キャラレベル・武器レベル・攻撃速度レベル・ポーション効果レベルの永続化
  - タイムスタンプ・日時情報の記録
  - user://saves/autosave.dat での安全な保存
  - 後方互換性維持（既存セーブデータの自動アップグレード）
- **ユーザーインターフェース**:
  - タイトル画面でのデータ削除ボタン（セーブ存在時のみ表示）
  - 確認モーダルによる誤削除防止
  - セーブ検出による自動ボタンテキスト変更

### スクロールシステム

- `ScrollerBase.gd`: スクロール要素の基底クラス
- `BackgroundScroller.gd`: 背景スクロール制御
- `GroundScroller.gd`: 地面スクロール制御
- `ScrollManager.gd`: 複数スクローラーの統一管理

### アセット

- `assets/sprites/kenney_pixel-platformer/`: ゲーム素材
  - `Tiles/Backgrounds/`: 背景画像 (tile_0008~0011)
  - `Tiles/Characters/`: キャラクター画像 (tile_0000~0001)
  - `Tiles/`: 地面タイル (tile_0022)、コイン画像 (tile_0151~0152)
- `assets/sprites/kenney_tiny-dungeon/`: 武器・アイテム素材
  - `Tiles/`: 武器画像 (tile_0103)、ポーション画像 (tile_0114)

## アーキテクチャ

### 階層化設計

1. **基底クラス**: ScrollerBase・EnemyBase で共通処理を統一
2. **具象クラス**: BackgroundScroller, GroundScroller, BasicEnemy で特化実装
3. **管理クラス**: ScrollManager で複数要素の制御、UIPositionHelper で UI 計算統一
4. **ユーティリティクラス**: HPBar・DamageText で再利用可能 UI コンポーネント
5. **定数管理**: GameConstants で論理的グループ分け

### プレイヤーシステム

- **スプライトアニメーション**: tile_0000/0001 の 2 フレーム歩行
- **武器システム**: 剣による攻撃アニメーション・ダメージ処理
- **HP システム**: HP バー表示・ダメージ受信・死亡処理
- **ダメージ表示**: 被ダメージ時のフロート数値表示
- **コイン収集システム**: 自動コイン取得・総数管理・UI反映
- **動的スケール**: GameConstants.PLAYER_SPRITE_SCALE (3.0 倍)
- **地面位置調整**: 自動計算による適切な接地
- **シグナル通知**: position_changed, player_reset, attack_started/finished, player_died, coin_collected

### エネミーシステム

- **継承アーキテクチャ**: EnemyBase 基底クラスによる拡張可能設計
- **戦闘状態管理**: 戦闘開始/終了の自動判定とアニメーション制御
- **攻撃パターン**: BasicEnemy の突進攻撃・ダメージ処理
- **HP システム**: 敵タイプ別 HP 設定・HP バー表示・死亡処理
- **ダメージ表示**: 被ダメージ時のフロート数値表示
- **コイン生成システム**: 死亡時の自動コイン生成・ランダム価値（10-20）
- **回復薬生成システム**: 死亡時の20%確率でポーションドロップ・即座回復処理
- **時間ベース出現**: 5秒間隔での自動敵出現・永続的無限ゲームプレイ
- **複数敵同時存在**: アクティブ敵配列による複数敵管理・画面上同時表示
- **タイプシステム**: EnemyType enum による敵種別管理
- **相対速度システム**: 背景スクロールと連動した自然な敵移動（相対速度50固定）
- **個別接敵距離システム**: 敵タイプ別の接敵距離設定（基本60・魔法使い300など）
- **魔法使い敵**: MAGEタイプの遠距離攻撃敵・魔法弾システム・接敵距離300・移動速度40

### 戦闘システム

- **複数敵同時攻撃**: 全ての戦闘中の敵が独立して同時に攻撃可能
- **個別攻撃タイマー**: 各敵が独自の攻撃間隔タイマーで攻撃管理
- **戦闘状態管理**: 各敵の個別戦闘状態（待機・移動・戦闘中）
- **自動戦闘開始**: プレイヤーとの距離判定による自動戦闘移行
- **双方向ダメージ**: プレイヤー ⇔ 複数敵の同時相互攻撃システム
- **攻撃タイミング**: 各敵の攻撃間隔による非同期攻撃
- **視覚フィードバック**: ダメージ数値・HP バー・攻撃アニメーション
- **ゲーム進行制御**: 戦闘中の背景スクロール停止・新規敵出現は継続
- **遠距離攻撃システム**: 魔法使い敵による魔法弾攻撃（距離300・2秒間隔・20ダメージ）

### スクロールシステム

- **無限ループ**: 背景 4 枚・地面 1 枚の連続スクロール
- **統一制御**: ScrollManager による速度・状態管理
- **拡張性**: 新しいスクロール要素の簡単追加

### コインシステム

- **即座取得**: 敵撃破と同時に自動取得（衝突判定不要）
- **視覚フィードバック**: コインアイコン（tile_0151/0152）の回転アニメーション
- **価値表示**: コイン横に "+10"~"+20" 数字表示（フォントメトリクス対応）
- **ランダムドロップ**: 10-20コインのランダム生成
- **UI統合**: リアルタイムゴールド表示更新（左上コインアイコン + 数値）
- **自動管理**: 2秒後の自動消失・プレイヤー総コイン数追跡

### 回復薬システム

- **即座回復**: 敵撃破時20%確率で即座にHP回復（衝突判定不要）
- **視覚フィードバック**: ポーションアイコン（tile_0114.png）の浮遊アニメーション
- **回復量表示**: ポーション横に "+20"~"+30" 緑色数字表示（レベル依存）
- **フロートテキスト**: 上昇する緑色回復量表示（視覚的フィードバック）
- **動的回復量**: ポーション効果レベルに応じた回復量（基本20 + レベル×5）
- **自動管理**: 3秒後の自動消失・視覚効果のみ

### シーン遷移システム

- **SceneTransition autoload**: グローバルなシーン遷移管理
- **フェード効果**: 黒画面フェードイン/アウトでスムーズな遷移
- **タイトル画面**: 段階的なフェードイン演出・ボタンアニメーション
- **ゲームオーバー画面**: 結果表示・スケールアニメーション登場
- **シーン構成**: タイトル → メインゲーム → ゲームオーバー → タイトル（ループ）

### 育成システム

- **PlayerStats シングルトン**: レベル・コイン数の永続管理
- **4種類のレベルアップ**:
  - キャラクター育成: レベルアップでHP増加（+20/レベル）
  - 武器育成: レベルアップで攻撃力増加（+5/レベル）
  - 攻撃速度育成: レベルアップで攻撃間隔短縮（-0.05秒/レベル、最小0.2秒）
  - ポーション効果育成: レベルアップで回復量増加（+5/レベル）
- **コストシステム**: レベル比例コスト（レベル×基本コスト、種類別基本コスト）
- **共通UIシステム**: UpgradePanelによる統一されたレベルアップUI
- **育成UI**: コイン数・レベルアップコスト・ステータス上昇量表示・2x2グリッド配置
- **アニメーション**: レベルアップ成功時のスケール・フラッシュ効果

### セーブシステム

- **SaveManager シングルトン**: 包括的なセーブ/ロード/削除管理
- **多段階オートセーブ**: 
  - 定期保存（30秒間隔）
  - トリガー保存（コイン消費時）
  - 開始時保存（ゲーム起動時）
- **インテリジェントUI**: 
  - セーブ検出による動的ボタンテキスト変更
  - セーブ存在時のみ削除ボタン表示
  - 確認モーダルによる安全な削除操作
- **堅牢なデータ管理**:
  - JSON形式での構造化データ保存
  - エラーハンドリング付きファイル操作
  - データ破損チェック機能
- **ユーザーエクスペリエンス**:
  - シームレスな進行状況復帰
  - 重要操作での即座保存
  - ESCキーによるモーダルキャンセル

### コード品質向上

- **継承設計**: 基底クラスによる機能の共通化
- **複数敵システム**: アクティブ敵配列・個別戦闘状態・独立攻撃タイマー管理
- **時間ベース設計**: Timer による敵出現・距離依存からの脱却
- **UI 位置計算統一**: UIPositionHelper による重複コード削減
- **動的位置計算**: スプライトサイズに基づく自動位置調整
- **ユーティリティクラス**: HPBar・DamageText の再利用可能設計
- **機能別セクション分け**: コードの可読性・保守性向上
- **一貫したログ**: 全クラスで統一されたログ出力形式
- **エラーハンドリング**: 安全なリソース読み込み処理

## テスト駆動開発

### 包括的テストスイート

- **プレイヤーテスト**: 移動・アニメーション・API
- **スクロールテスト**: ScrollManager・スクローラー状態
- **定数整合性テスト**: GameConstants の論理チェック
- **統合テスト**: システム全体の連携確認

### テスト実行

- **F12 キー**: 全自動テスト実行
- **手動テスト**: UI ボタンでの動作確認
- **デバッグログ**: 構造化された詳細ログ
